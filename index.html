<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>A Game Of Surveys</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}
#topLeft { position:absolute; top:10px; left:10px; }
#topRight { position:absolute; top:10px; right:10px; }
#progress { text-align:center; font-size:32px; margin-top:40px; }
#container { max-width:700px; margin:120px auto; text-align:center; }
button { margin-top:25px; padding:10px 30px; font-size:16px; }
textarea { width:90%; height:80px; }
label { display:block; margin:6px; }
</style>
</head>

<body>

<div id="topLeft"></div>
<div id="topRight"></div>
<div id="progress"></div>
<div id="container"></div>

<script>
/* =====================
   GLOBAL STATE
===================== */
let level = 0;
let step = 0;
let trickChance = 0;

/* =====================
   SAVE / LOAD
===================== */
function save() {
  localStorage.setItem("surveySave", JSON.stringify({ level, step, trickChance }));
}
function loadSave() {
  const d = JSON.parse(localStorage.getItem("surveySave"));
  if (d) ({ level, step, trickChance } = d);
}

/* =====================
   DISQUALIFY
===================== */
function disqualify(msg) {
  localStorage.clear();
  document.body.innerHTML =
    `<h1 style="text-align:center;margin-top:120px;">${msg}</h1>`;
}

/* =====================
   TEXT VALIDATION (STRICT)
===================== */
function invalidText(text) {
  const t = text.trim().toLowerCase();
  if (t.length < 12) return true;
  if (/^(.)\1{6,}$/.test(t.replace(/\s/g,""))) return true;

  const words = t.split(/\s+/);
  const unique = new Set(words);
  if (unique.size < 4) return true;

  const letters = t.replace(/[^a-z]/g,"").length;
  if (letters / t.length < 0.6) return true;

  return false;
}

/* =====================
   LEVEL DATA
===================== */

// LEVEL 0
const level0 = [
  { type:"radio", text:"What is your gender?", options:["Man","Woman"] },
  { type:"radio", text:"How old are you?", options:["Under 18","18-24","25-34","35-44","45-56","57-70","Over 70"] },
  { type:"radio", text:"What is your job?", options:["Engineer","Firefighter","College"] }
];

// LEVEL 1 (20)
const level1 = Array.from({length:20}, (_,i)=>({
  type: i%3===0?"text":i%3===1?"radio":"slider",
  text: `Level 1 Question ${i+1}`,
  options:["Yes","No","Sometimes","Not sure"]
}));

// LEVEL 2 (40)
const level2 = Array.from({length:40}, (_,i)=>({
  type: i%3===0?"text":i%3===1?"radio":"slider",
  text: `Level 2 Question ${i+1}`,
  options:["A","B","C","D"]
}));

/* =====================
   TRICK QUESTION
===================== */
function maybeTrick() {
  if (level !== 2) return null;
  if (Math.random() * 100 < trickChance) {
    if (Math.random() < 0.5) {
      const letters = ["A","B","C","D"];
      const correct = letters[Math.floor(Math.random()*4)];
      return {
        type:"radio",
        trick:true,
        correct,
        text:`This question is different. Please select "${correct}".`,
        options:letters
      };
    } else {
      const correct = Math.floor(Math.random()*10)+1;
      return {
        type:"slider",
        trick:true,
        correct,
        text:`Verification check: slide to ${correct}.`
      };
    }
  }
  return null;
}

/* =====================
   RENDER
===================== */
function render() {
  const c = document.getElementById("container");
  c.innerHTML = "";

  document.getElementById("topLeft").innerText =
    level===0?"Level 0":level===1?"Level 1":"Level 2: Mixing";

  document.getElementById("topRight").innerText =
    level<2?"":`Trick Chance: ${trickChance.toFixed(2)}%`;

  const total = level===0?3:level===1?20:40;
  document.getElementById("progress").innerText =
    level===0?"":`${step}/${total}`;

  if (step===0) {
    c.innerHTML = `<p>${
      level===0?"Hello, this survey will take 2.5 minutes.":
      level===1?"Hello, this survey will take 7 minutes.":
      "Hi, this survey will take approximately 15 minutes."
    }</p>`;
    return addContinue();
  }

  let q = maybeTrick() ||
    (level===0?level0:level===1?level1:level2)[step-1];

  c.innerHTML += `<h2>${q.text}</h2>`;

  if (q.type==="radio") {
    q.options.forEach(o=>{
      c.innerHTML += `<label><input type="radio" name="ans" value="${o}"> ${o}</label>`;
    });
  }
  if (q.type==="text") c.innerHTML += `<textarea></textarea>`;
  if (q.type==="slider") c.innerHTML += `<input type="range" min="1" max="10" value="5">`;

  c.dataset.trick = q.trick ? JSON.stringify(q) : "";
  addContinue();
}

/* =====================
   CONTINUE
===================== */
function addContinue() {
  const b=document.createElement("button");
  b.innerText="Continue";
  b.onclick=next;
  container.appendChild(b);
}

function next() {
  const c = document.getElementById("container");

  if (c.dataset.trick) {
    const t = JSON.parse(c.dataset.trick);
    if (t.type==="radio") {
      const v=document.querySelector("input[name=ans]:checked")?.value;
      if (v!==t.correct) return disqualify("You failed a verification question.");
    }
    if (t.type==="slider") {
      const v=document.querySelector("input[type=range]").value;
      if (+v!==t.correct) return disqualify("You failed a verification question.");
    }
  }

  if (document.querySelector("textarea")) {
    if (invalidText(document.querySelector("textarea").value))
      return disqualify("Invalid or meaningless answer detected.");
  }

  step++;

  if (level===0 && step>3) { level=1; step=0; }
  if (level===1 && step>20) { level=2; step=0; trickChance=0; }

  if (level===2) trickChance += 0.25;

  save();
  render();
}

/* =====================
   START
===================== */
loadSave();
render();
</script>

</body>
</html>
