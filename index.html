<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Survey Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PARTICLES -->
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  background:#050814;
  color:white;
  font-family:system-ui,sans-serif;
  overflow:hidden;
}
#particles-js{
  position:fixed;
  width:100%;
  height:100%;
  z-index:-1;
}
#app{
  max-width:900px;
  margin:auto;
  padding:30px;
}
button{
  padding:14px 20px;
  border:none;
  border-radius:12px;
  font-size:16px;
  cursor:pointer;
}
.primary{background:#4f7cff;color:white}
.secondary{background:#333;color:white}
.choice{display:block;width:100%;margin:8px 0}
.progress{height:10px;background:#222;border-radius:10px;overflow:hidden}
.progress div{height:100%;background:#4f7cff}
.topLeft{
  position:fixed;
  top:10px;
  left:10px;
  font-weight:bold;
}
.fade{animation:fade .4s}
@keyframes fade{from{opacity:0}to{opacity:1}}
</style>
</head>

<body>

<div id="particles-js"></div>
<div class="topLeft" id="coinsUI">ðŸª™ Coins: 0</div>
<div id="app"></div>

<script>
/* ================= PARTICLES INIT ================= */
particlesJS("particles-js",{
  particles:{
    number:{value:60},
    color:{value:"#4f7cff"},
    shape:{type:"circle"},
    opacity:{value:0.6},
    size:{value:2},
    move:{enable:true,speed:1}
  },
  interactivity:{
    events:{onhover:{enable:true,mode:"repulse"}}
  }
});

/* ================= STATE ================= */
let state = JSON.parse(localStorage.getItem("surveyState")) || {
  step:0,
  coins:0,
  answers:{}
};

/* ================= AUDIO ENGINE (iOS SAFE) ================= */
let audioCtx;

function initAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playBirds(){
  initAudio();
  for(let i=0;i<6;i++){
    const osc = audioCtx.createOscillator();
    osc.frequency.value = 1200 + Math.random()*800;
    osc.connect(audioCtx.destination);
    osc.start(audioCtx.currentTime + i*0.25);
    osc.stop(audioCtx.currentTime + i*0.25 + 0.1);
  }
}

function playWolf(){
  initAudio();
  const osc = audioCtx.createOscillator();
  osc.type="sine";
  osc.frequency.setValueAtTime(180,audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(80,audioCtx.currentTime+3);
  osc.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+3);
}

function playTraffic(){
  initAudio();
  const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate*3, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start();
}

/* ================= SURVEY ================= */
const survey = [
  {type:"info", text:"The first questions collect personal information."},
  {type:"sound"},
  {type:"choice", q:"What did you hear?", o:["Birds Chirping","Wolf Howling","Noisy Traffic"]},
  {type:"choice", q:"What is your gender?", o:["Man","Woman"]},
  {type:"choice", q:"Your age?", o:["-18","20-30","30-40","40-50","50+"]},
  {type:"input", q:"Zip Code (numbers only)"}
];

let soundPlayed=false;
let lastSound="";

function render(){
  $("coinsUI").textContent="ðŸª™ Coins: "+state.coins;
  const q = survey[state.step];
  if(!q){ return endSurvey(); }

  let html=`<div class="fade">
    <div class="progress"><div style="width:${(state.step/survey.length)*100}%"></div></div>`;

  if(q.type==="info"){
    html+=`<p>${q.text}</p><button class="primary" onclick="next()">Continue</button>`;
  }

  if(q.type==="sound"){
    html+=`
      <h3>Sound Check</h3>
      <button class="primary" onclick="playSound()">â–¶ Play Sound</button><br><br>
      <button id="continueBtn" class="secondary" disabled onclick="next()">Continue</button>
    `;
  }

  if(q.type==="choice"){
    html+=`<h3>${q.q}</h3>`;
    q.o.forEach(o=>{
      html+=`<button class="choice primary" onclick="answer('${o}')">${o}</button>`;
    });
  }

  if(q.type==="input"){
    html+=`
      <h3>${q.q}</h3>
      <input id="inp" style="width:100%;padding:12px"><br><br>
      <button class="primary" onclick="answerInput()">Continue</button>
    `;
  }

  html+=`</div>`;
  $("app").innerHTML=html;
}

function playSound(){
  soundPlayed=true;
  const r=Math.random();
  if(r<0.33){ playBirds(); lastSound="Birds Chirping"; }
  else if(r<0.66){ playWolf(); lastSound="Wolf Howling"; }
  else{ playTraffic(); lastSound="Noisy Traffic"; }
  setTimeout(()=>{$("continueBtn").disabled=false},3000);
}

function answer(v){
  state.answers[state.step]=v;
  state.coins++;
  state.step++;
  save(); render();
}

function answerInput(){
  const v=$("inp").value.trim();
  if(!v) return;
  state.answers[state.step]=v;
  state.coins++;
  state.step++;
  save(); render();
}

function next(){
  state.step++;
  save(); render();
}

function endSurvey(){
  $("app").innerHTML=`
    <h2>Survey Complete</h2>
    <p>You may now continue.</p>
    <button class="secondary" onclick="restart()">Start Over Survey</button>
  `;
}

function restart(){
  state.step=0;
  state.answers={};
  save(); render();
}

function save(){
  localStorage.setItem("surveyState",JSON.stringify(state));
}
const $=id=>document.getElementById(id);

render();
</script>
</body>
</html>
