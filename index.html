/* ================= PARTICLES ================= */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let W, H, particles = [];

function resize() {
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

for (let i = 0; i < 140; i++) {
  particles.push({
    x: Math.random() * W,
    y: Math.random() * H,
    r: Math.random() * 2 + 0.6,
    vx: (Math.random() - 0.5) * 0.35,
    vy: (Math.random() - 0.5) * 0.35
  });
}

(function tick() {
  ctx.clearRect(0, 0, W, H);
  for (const p of particles) {
    p.x += p.vx;
    p.y += p.vy;
    if (p.x < 0 || p.x > W) p.vx *= -1;
    if (p.y < 0 || p.y > H) p.vy *= -1;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(124,243,192,.35)";
    ctx.fill();
  }
  requestAnimationFrame(tick);
})();

/* ================= DATA ================= */
const QUESTIONS = [
  "What does success mean to you?",
  "What motivates you to stay focused?",
  "How do you handle stress?",
  "What skill are you improving?",
  "What makes work meaningful?",
  "What helps you stay disciplined?",
  "What inspires creativity?",
  "What defines progress?",
  "What motivates long-term growth?",
  "What builds confidence?",
  "What does leadership mean?",
  "How do you overcome setbacks?",
  "What helps teamwork succeed?",
  "What keeps you productive?",
  "What defines responsibility?",
  "What inspires learning?",
  "What drives improvement?",
  "What makes a goal worthwhile?",
  "What keeps you motivated daily?",
  "What does balance mean to you?"
];

const app = document.getElementById("app");

/* ================= STATE ================= */
let state = JSON.parse(localStorage.getItem("save")) || {
  q: 0,
  trickChance: 5,
  inTrick: false,
  trick: null
};

function save() {
  localStorage.setItem("save", JSON.stringify(state));
}

/* ================= SURVEY ================= */
function renderSurvey() {
  save();

  // ðŸ”’ safety reset
  if (state.inTrick && !state.trick) {
    state.inTrick = false;
  }

  if (state.inTrick) return renderTrick();
  if (state.q >= QUESTIONS.length) return finish();

  const pct = Math.round((state.q / QUESTIONS.length) * 100);

  app.innerHTML = `
  <div class="card">
    <div class="top">
      <div>${state.q + 1}/${QUESTIONS.length}</div>
      <div class="${state.trickChance >= 50 ? "warn" : ""}">
        Trick Chance: ${state.trickChance}%
      </div>
    </div>

    <div class="progress">
      <div style="width:${pct}%"></div>
    </div>

    <p>${QUESTIONS[state.q]}</p>
    <textarea id="ans"></textarea>

    <div class="row">
      <button id="next" disabled>Continue</button>
    </div>
  </div>
  `;

  const ans = document.getElementById("ans");
  const next = document.getElementById("next");

  ans.oninput = () => {
    next.disabled = !ans.value.trim().match(/\b\w+\b/);
  };

  next.onclick = () => {
    state.q++;
    state.trickChance = Math.min(100, state.trickChance + 1);

    if (Math.random() * 100 < state.trickChance) {
      spawnTrick();
    }

    renderSurvey();
  };
}

/* ================= TRICKS ================= */
function spawnTrick() {
  state.inTrick = true;
  const r = Math.random();

  if (r < 0.25) state.trick = { type: "letter" };
  else if (r < 0.5) state.trick = { type: "image" };
  else if (r < 0.75)
    state.trick = { type: "slider", target: 1 + Math.floor(Math.random() * 10) };
  else
    state.trick = {
      type: "clicker",
      score: 0,
      ppc: 1,
      crit: 0.1,
      multi: 2,
      costCrit: 50,
      costMulti: 1000
    };
}

/* ================= CLICKER ================= */
function renderClicker() {
  const t = state.trick;
  const pct = Math.min(100, (t.score / 1e6) * 100);

  app.innerHTML = `
  <div class="card center" style="position:relative">
    <h3>Verification Clicker</h3>
    <div class="money">${Math.floor(t.score)}</div>

    <div class="progress"><div style="width:${pct}%"></div></div>

    <p>PPC: ${t.ppc}</p>
    <p>Crit Chance: ${t.crit.toFixed(2)}% | x${t.multi.toFixed(1)}</p>

    <button onclick="clickBtn(event)">Click</button>

    <h4>Upgrades</h4>
    <div class="row">
      <button onclick="t.ppc++">+1 PPC (free)</button>
      <button onclick="buyCrit()">+1% Crit (${Math.floor(t.costCrit)})</button>
      <button onclick="buyMulti()">+0.1 Multi (${Math.floor(t.costMulti)})</button>
    </div>

    ${t.score >= 1e6 ? `<button onclick="passTrick()">Continue</button>` : ""}
  </div>
  `;
}

function clickBtn(e) {
  const t = state.trick;
  let gain = t.ppc;
  let crit = Math.random() * 100 < t.crit;

  if (crit) gain *= t.multi;
  t.score += gain;

  save();
  renderClicker();
}

function buyCrit() {
  const t = state.trick;
  if (t.score < t.costCrit) return;
  t.score -= t.costCrit;
  t.crit += 1;
  t.costCrit *= 1.2;
  renderClicker();
}

function buyMulti() {
  const t = state.trick;
  if (t.score < t.costMulti) return;
  t.score -= t.costMulti;
  t.multi += 0.1;
  t.costMulti *= 1.4;
  renderClicker();
}

/* ================= OTHER TRICKS ================= */
function renderTrick() {
  const t = state.trick;
  if (!t) return renderSurvey();

  if (t.type === "letter") {
    app.innerHTML = `<div class="card center"><h3>Select D</h3>
    ${["A","B","C","D"].map(l => `<button onclick="lPick('${l}')">${l}</button>`).join("")}
    </div>`;
  }

  if (t.type === "image") {
    app.innerHTML = `<div class="card center">
    <img src="tomato.png" width="200">
    <div class="row">
    ${["Corn","Tomato","Egg","Avocado"].map(o => `<button onclick="iPick('${o}')">${o}</button>`).join("")}
    </div></div>`;
  }

  if (t.type === "slider") {
    app.innerHTML = `<div class="card center">
    <h3>Slide to ${t.target}</h3>
    <input type="range" min="1" max="10" id="s">
    <button onclick="sPick()">Submit</button>
    </div>`;
  }

  if (t.type === "clicker") renderClicker();
}

function lPick(l) { l === "D" ? passTrick() : reset(); }
function iPick(o) { o === "Tomato" ? passTrick() : reset(); }
function sPick() {
  document.getElementById("s").value == state.trick.target
    ? passTrick()
    : reset();
}

function passTrick() {
  state.inTrick = false;
  state.trick = null;
  save();
  renderSurvey();
}

function finish() {
  app.innerHTML = `<div class="card center"><h2>Survey Complete ðŸŽ‰</h2></div>`;
}

function reset() {
  localStorage.removeItem("save");
  location.reload();
}

/* ================= START ================= */
renderSurvey();
