<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>A Game Of Surveys</title>

<style>
body{font-family:Arial;margin:0;background:#fff}
#top{display:flex;justify-content:space-between;padding:12px}
#progressOuter{width:300px;height:18px;background:#ddd;border-radius:10px}
#progressInner{height:100%;width:0%;background:#4caf50;border-radius:10px}
.warning{color:red;font-weight:bold}
button{padding:10px 20px;margin:10px}
textarea{width:320px;height:90px}
input[type=range]{width:300px}
img{max-width:200px}
</style>
</head>

<body>

<div id="top">
  <div>
    <div id="progressText"></div>
    <div id="progressOuter"><div id="progressInner"></div></div>
    <div id="growth"></div>
  </div>
  <div id="trick"></div>
</div>

<div id="container"></div>

<script>
/* ========== STATE ========== */
let state={
 level:0,
 step:0,
 trickChance:2,
 resumed:false,
 clicker:{
  score:0,
  clicks:[],
  multiplier:1
 }
};

/* ========== SAVE / LOAD ========== */
function save(){
 localStorage.setItem("surveySave",JSON.stringify(state));
}
function load(){
 const d=localStorage.getItem("surveySave");
 if(!d) return false;
 state=JSON.parse(d);
 state.resumed=true;
 return true;
}
function resetAll(){
 localStorage.clear();
 location.reload();
}

/* ========== GROWTH ========== */
function growthRate(){
 return [0,0.1,0.33,1,5][state.level]||5;
}

/* ========== QUESTIONS ========== */
function makeQuestions(count){
 return Array.from({length:count},(_,i)=>`What does success mean to you in question ${i+1}?`);
}
const questions={
 1:makeQuestions(20),
 2:makeQuestions(20),
 3:makeQuestions(40),
 4:makeQuestions(60)
};

/* ========== VALIDATION ========== */
function validText(t){
 const words=t.trim().split(/\s+/);
 if(words.length<10) return false;
 const unique=new Set(words.map(w=>w.toLowerCase()));
 if(unique.size<5) return false;
 return true;
}

/* ========== TRICK ========== */
function generateTrick(){
 const r=Math.random();
 if(r<0.15) return {type:"clicker"};
 if(r<0.35) return {
  type:"image",
  text:"What is shown?",
  options:["Corn","Tomato","Egg","Avocado"],
  correct:"Tomato"
 };
 const letters=["A","B","C","D"];
 const c=letters[Math.floor(Math.random()*4)];
 return {type:"letter",text:`Please select "${c}"`,options:letters,correct:c};
}

/* ========== RENDER ========== */
function render(){
 const c=document.getElementById("container");
 const p=document.getElementById("progressText");
 const bar=document.getElementById("progressInner");
 const t=document.getElementById("trick");
 const g=document.getElementById("growth");

 g.textContent=`Growth Rate: +${growthRate()}% / question`;

 t.innerHTML=state.trickChance>=50
  ? `<span class="warning">âš  Trick Chance ${state.trickChance.toFixed(2)}%</span>`
  : `Trick Chance: ${state.trickChance.toFixed(2)}%`;

 if(state.level===0 && !state.resumed){
  c.innerHTML=`
   <h2>Hello</h2>
   <p>This survey takes ~7 minutes</p>
   <button onclick="state.level=1;render()">Start</button>
   <button onclick="load()?render():alert('No save')">Resume</button>
  `;
  return;
 }

 const total=questions[state.level]?.length||0;
 p.textContent=`${state.step}/${total}`;
 bar.style.width=(state.step/total*100)+"%";

 if(state.step>=total){
  state.level++;
  state.step=0;
  save();
  render();
  return;
 }

 if(state.level>=1 && Math.random()*100<state.trickChance){
  const trick=generateTrick();
  renderTrick(trick);
  return;
 }

 const q=questions[state.level][state.step];
 c.innerHTML=`
  <h2>${q}</h2>
  <textarea id="txt"></textarea>
  <button onclick="submitText()">Continue</button>
 `;
}

/* ========== SUBMIT ========== */
function submitText(){
 const t=document.getElementById("txt").value;
 if(!validText(t)){
  alert("Invalid answer");
  resetAll();
  return;
 }
 advance(false);
}

/* ========== ADVANCE ========== */
function advance(isTrick){
 const inc=isTrick?growthRate()/100:growthRate();
 state.trickChance=Math.min(100,state.trickChance+inc);
 state.step++;
 save();
 render();
}

/* ========== CLICKER ========== */
function renderTrick(trick){
 const c=document.getElementById("container");

 if(trick.type==="clicker"){
  c.innerHTML=`
   <h2>Verification Challenge</h2>
   <div>Score: ${state.clicker.score}</div>
   <div id="cps"></div>
   <div style="width:300px;background:#ddd">
    <div style="height:16px;background:#4caf50;width:${Math.min(100,state.clicker.score/10000)}%"></div>
   </div>
   <button onclick="click()">Click Me</button>
   <button onclick="upgrade()">Upgrade (x2)</button>
   ${state.clicker.score>=1e6?'<button onclick="finishClicker()">Continue</button>':''}
  `;
  return;
 }

 c.innerHTML=`
  <h2>${trick.text}</h2>
  ${trick.type==="image"?'<img src="tomato.png">':''}
  ${trick.options.map(o=>`
   <div><input type="radio" name="a" value="${o}">${o}</div>`).join("")}
  <button onclick="submitTrick('${trick.correct}')">Continue</button>
 `;
}

function click(){
 const now=Date.now();
 state.clicker.clicks.push(now);
 state.clicker.clicks=state.clicker.clicks.filter(t=>now-t<1000);
 const cps=state.clicker.clicks.length;
 document.getElementById("cps").textContent=`CPS: ${cps}`;
 if(cps>=15){
  alert("Cheating detected");
  resetAll();
 }
 state.clicker.score+=state.clicker.multiplier;
 save();
 render();
}
function upgrade(){
 state.clicker.multiplier=2;
 save();
 render();
}
function finishClicker(){
 state.clicker={score:0,clicks:[],multiplier:1};
 advance(true);
}
function submitTrick(correct){
 const v=document.querySelector("input[name=a]:checked");
 if(!v||v.value!==correct){
  alert("Disqualified");
  resetAll();
  return;
 }
 advance(true);
}

render();
</script>
</body>
</html>
