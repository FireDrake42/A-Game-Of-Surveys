<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>A Game Of Surveys</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: Arial, sans-serif;
}

.level { position: absolute; top: 10px; left: 10px; }
.trick { position: absolute; top: 10px; right: 10px; }
.progress { font-size: 28px; margin-bottom: 20px; }

.container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
}

.options label {
  display: block;
  margin: 6px;
  font-size: 17px;
}

textarea { width: 360px; height: 100px; }
input[type="range"] { width: 300px; }

.rangeValue { margin-top: 8px; }

button {
  margin-top: 20px;
  padding: 10px 28px;
  font-size: 16px;
}
</style>
</head>

<body>

<div id="levelText" class="level"></div>
<div id="trickChance" class="trick"></div>

<div class="container">
  <div id="progress" class="progress"></div>
  <div id="question"></div>
  <div id="options" class="options"></div>
  <button id="continueBtn">Continue</button>
</div>

<script>
/* ========= STATE ========= */
let level = 0;
let step = 0;
let trickChance = 2.0;
let activeTrick = null;

/* ========= ELEMENTS ========= */
const qEl = document.getElementById("question");
const oEl = document.getElementById("options");
const btn = document.getElementById("continueBtn");
const lvlText = document.getElementById("levelText");
const prog = document.getElementById("progress");
const trickEl = document.getElementById("trickChance");

/* ========= TEXT VALIDATION ========= */
function invalidTextAnswer(text) {
  const clean = text.toLowerCase().trim();
  if (clean.length < 10) return true;
  if (/^(.)\1{6,}$/.test(clean.replace(/\s+/g, ""))) return true;
  const words = clean.split(/\s+/);
  if (new Set(words).size <= 2) return true;
  return false;
}

/* ========= LEVEL DATA ========= */

const level2Greeting = {
  type:"msg",
  text:"Hi, this survey will take you approximately 15min!"
};

const level2Questions = Array.from({ length: 40 }, (_, i) => {
  if (i % 7 === 0)
    return { type:"slider", text:"How mentally demanding was this task?" };
  if (i % 6 === 0)
    return { type:"multi", text:"Which of these apply to you?", options:["Focus","Stress","Motivation","Fatigue"] };
  if (i % 5 === 0)
    return { type:"text10", text:"Explain your reasoning in detail." };
  return {
    type:"radio",
    text:`Decision-based question ${i + 1}`,
    options:["Strongly Agree","Agree","Neutral","Disagree"]
  };
});

/* ========= TRICKS ========= */

const trickTexts = [
  "Attention check: select option “{X}”.",
  "Verification question: choose “{X}”.",
  "Please select “{X}” to continue."
];

function rollTrickLevel2() {
  if (Math.random() * 100 >= trickChance) return null;

  if (Math.random() < 0.2) {
    const target = Math.floor(Math.random() * 10) + 1;
    return {
      type:"trickSlider",
      text:`Please slide to the number ${target} (1–10) to verify your attention.`,
      correct: target
    };
  } else {
    const letters = ["A","B","C","D"];
    const correct = letters[Math.floor(Math.random()*4)];
    const text = trickTexts[Math.floor(Math.random()*trickTexts.length)]
      .replace("{X}", correct);
    return { type:"trick", text, options:letters, correct };
  }
}

/* ========= CORE ========= */

function disqualify(msg){
  qEl.textContent = msg;
  oEl.innerHTML = "";
  btn.style.display = "none";
}

function load(){
  oEl.innerHTML="";
  btn.disabled=true;
  activeTrick=null;

  if(level === 2){
    prog.textContent = step === 0 ? "0/40" : `${step}/40`;
    trickEl.textContent = `Trick Chance: ${trickChance.toFixed(1)}%`;
    lvlText.textContent = "Level 2: Mixing";
  }

  let q;
  if(step === 0){
    q = level2Greeting;
  } else {
    q = level2Questions[step - 1];
    activeTrick = rollTrickLevel2();
    if(activeTrick) q = activeTrick;
  }

  qEl.textContent = q.text;

  if(q.type === "msg"){
    btn.disabled = false;
    btn.onclick = nextStep;
    return;
  }

  if(q.type === "radio" || q.type === "trick"){
    q.options.forEach(opt=>{
      const l=document.createElement("label");
      l.innerHTML=`<input type="radio" name="ans"> ${opt}`;
      oEl.appendChild(l);
    });
    document.querySelectorAll("input").forEach(r=>r.onchange=()=>btn.disabled=false);
  }

  if(q.type === "multi"){
    q.options.forEach(opt=>{
      const l=document.createElement("label");
      l.innerHTML=`<input type="checkbox"> ${opt}`;
      oEl.appendChild(l);
    });
    btn.disabled = false;
  }

  if(q.type === "text" || q.type === "text10"){
    const t=document.createElement("textarea");
    oEl.appendChild(t);
    t.oninput=()=>btn.disabled=false;
  }

  if(q.type === "slider" || q.type === "trickSlider"){
    const r=document.createElement("input");
    r.type="range"; r.min=1; r.max=10; r.value=5;
    const v=document.createElement("div");
    v.className="rangeValue";
    v.textContent="Value: 5";
    r.oninput=()=>{v.textContent="Value: "+r.value; btn.disabled=false;};
    oEl.appendChild(r); oEl.appendChild(v);
  }

  btn.onclick = nextStep;
}

function nextStep(){
  if(activeTrick){
    if(activeTrick.type==="trick"){
      const v=document.querySelector("input:checked").nextSibling.textContent.trim();
      if(v!==activeTrick.correct){ disqualify("You failed an attention check."); return; }
    }
    if(activeTrick.type==="trickSlider"){
      const v=document.querySelector("input[type=range]").value;
      if(+v!==activeTrick.correct){ disqualify("You failed an attention check."); return; }
    }
  }

  if(step > 0){
    const q = level2Questions[step - 1];
    if(q && (q.type==="text"||q.type==="text10")){
      const input=document.querySelector("textarea").value;
      if(invalidTextAnswer(input)){
        disqualify("Invalid response detected.");
        return;
      }
    }
  }

  step++;
  trickChance = Math.min(trickChance + 0.1, 10);

  if(step > 40){
    qEl.textContent = "End of Level 2";
    oEl.innerHTML = "";
    btn.style.display = "none";
    return;
  }

  load();
}

/* START LEVEL 2 DIRECTLY FOR NOW */
level = 0;
step = 0;
trickChance = 0.0;
load();
</script>

</body>
</html>
